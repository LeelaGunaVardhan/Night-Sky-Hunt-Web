<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Night Sky Hunt</title>
    <!-- Google Font for Stylish Title -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Reset default browser styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Set body styles with dark background */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Starfield container */
        .starfield {
            position: absolute;
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
            top: 0;
            left: 0;
            z-index: -1;
        }

        /* Keyframes for star animation */
        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.2; }
        }

        /* Generate stars */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 2s infinite;
        }

        /* Title styling with vibrant gradient and 3D effect */
        .title {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            font-size: 3em;
            background: linear-gradient(45deg, #ff8a00, #e52e71, #9b00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
            margin-bottom: 20px;
        }

        /* Floating Animation for Title */
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Button Container */
        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Main Button styling */
        .main-button {
            background-color: #1e90ff;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease, transform 0.2s;
        }

        .main-button:hover {
            background-color: #63b3ff;
            transform: scale(1.05);
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            background-color: rgba(0, 0, 0, 0.6);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid #fff;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: #fff;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover, .close:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        /* Form styling inside modals */
        .modal-content input[type="text"],
        .modal-content input[type="password"],
        .modal-content input[type="number"],
        .modal-content input[type="email"],
        .modal-content input[type="datetime-local"] {
            width: 100%;
            padding: 15px 20px;
            margin: 10px 0;
            box-sizing: border-box;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .modal-content input::placeholder {
            color: #ccc;
        }

        .modal-content button {
            width: 100%;
            background-color: #1e90ff;
            color: white;
            padding: 15px 20px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease, transform 0.2s;
        }

        .modal-content button:hover {
            background-color: #63b3ff;
            transform: scale(1.05);
        }

        .modal-content h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2em;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .modal-content .output {
            margin-top: 20px;
            font-size: 1.2em;
            text-align: center;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        /* Coordinate Finder styling */
        .container {
            background-color: rgba(0, 0, 0, 0.6);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #fff;
            max-width: 500px;
            margin: 20px auto;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: none;
        }

        .container button.logout-button {
            background-color: #ff4d4d;
        }

        /* Admin Dashboard styling */
        .admin-dashboard {
            background-color: rgba(0, 0, 0, 0.6);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #fff;
            max-width: 600px;
            margin: 20px auto;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: none;
        }

        .admin-dashboard h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2em;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .admin-dashboard button {
            width: 100%;
            background-color: #1e90ff;
            color: white;
            padding: 15px 20px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s ease, transform 0.2s;
        }

        .admin-dashboard button:hover {
            background-color: #63b3ff;
            transform: scale(1.05);
        }

        .admin-dashboard button.reset-button {
            background-color: #ff4d4d;
        }

        .admin-dashboard button.reset-button:hover {
            background-color: #ff8080;
        }

        .admin-output {
            margin-top: 20px;
            font-size: 1em;
            color: #fff;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Responsive design */
        @media (max-width: 600px) {
            .title {
                font-size: 2em;
                margin-top: 30px;
            }

            .modal-content h2, .container h2, .admin-dashboard h2 {
                font-size: 1.5em;
            }

            .main-button, .modal-content button, .admin-dashboard button {
                font-size: 1em;
                padding: 10px 15px;
            }

            .modal-content input[type="text"],
            .modal-content input[type="password"],
            .modal-content input[type="number"],
            .modal-content input[type="email"],
            .modal-content input[type="datetime-local"] {
                font-size: 1em;
                padding: 10px 15px;
            }

            .modal-content .output, .admin-output {
                font-size: 1em;
            }
        }

        /* Floating Admin Option Modals */
        .admin-option-modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 500px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
        }

        .admin-option-modal .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }

        .admin-option-modal .close:hover {
            color: #fff;
        }

        .admin-option-modal h3 {
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .admin-option-modal pre {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 300px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Reset Confirmation Modal */
        .reset-modal {
            display: none;
            position: fixed;
            z-index: 1600;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            color: #fff;
            text-align: center;
        }

        .reset-modal .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }

        .reset-modal .close:hover {
            color: #fff;
        }

        .reset-modal h3 {
            margin-bottom: 15px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .reset-modal button {
            width: 45%;
            background-color: #ff4d4d;
            color: white;
            padding: 10px 0;
            margin: 10px 5%;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s;
        }

        .reset-modal button:hover {
            background-color: #ff8080;
            transform: scale(1.05);
        }

        /* Set Time Modal */
        .set-time-modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
        }

        .set-time-modal .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }

        .set-time-modal .close:hover {
            color: #fff;
        }

        .set-time-modal h3 {
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .set-time-modal label {
            display: block;
            margin: 10px 0 5px;
            text-align: left;
            font-size: 1em;
        }

        .set-time-modal input[type="datetime-local"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
        }

        .set-time-modal button {
            width: 100%;
            background-color: #1e90ff;
            color: white;
            padding: 10px 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s;
        }

        .set-time-modal button:hover {
            background-color: #63b3ff;
            transform: scale(1.05);
        }

        .set-time-modal .output {
            margin-top: 10px;
            font-size: 1em;
            text-align: center;
            color: #ffcc00;
        }

        /* Additional styles for registration requests */
        .registration-request {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .registration-request button {
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .registration-request button:hover {
            background-color: #5cb85c;
        }

        .acceptance-code {
            font-weight: bold;
            color: #ffcc00;
        }
    </style>
</head>
<body>

    <!-- Starfield Background -->
    <div class="starfield" id="starfield"></div>

    <!-- Title -->
    <div class="title">Night Sky Hunt</div>

    <!-- Button Container -->
    <div class="button-container" id="buttonContainer">
        <button class="main-button" onclick="openAddTeamModal()">Register Team</button>
        <button class="main-button" onclick="openStartHuntModal()">Team Login</button>
        <button class="main-button" onclick="openAdminLoginModal()">Admin Login</button>
    </div>

    <!-- Add Team Modal -->
    <div id="addTeamModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addTeamModal')">&times;</span>
            <h2>Register Your Team</h2>
            <form id="teamForm">
                <div id="memberInputs">
                    <!-- Member inputs will be added here -->
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button type="button" onclick="addMember()">Add Member</button>
                    <button type="button" onclick="removeMember()">Remove Member</button>
                </div>
                <input type="text" id="teamName" placeholder="Enter Team Name" required>
                <input type="email" id="teamLeaderEmail" placeholder="Enter Team Leader's Email" required>
                <input type="password" id="teamPassword" placeholder="Create a Team Password" required>
                <div id="acceptanceCodeSection" style="display: none;">
                    <input type="text" id="acceptanceCodeInput" placeholder="Enter Acceptance Code" required>
                </div>
                <button type="button" onclick="registerTeam()">Register Team</button>
            </form>
            <div class="output" id="addTeamOutput"></div>
        </div>
    </div>

    <!-- Team Login Modal -->
    <div id="startHuntModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('startHuntModal')">&times;</span>
            <h2>Team Login</h2>
            <input type="text" id="teamNameLogin" placeholder="Enter Your Team Name" required>
            <input type="password" id="teamPasswordLogin" placeholder="Enter Team Password" required>
            <button type="button" onclick="teamLogin()">Login</button>
            <div class="output" id="startHuntOutput"></div>
        </div>
    </div>

    <!-- Start Hunt Button Container -->
    <div id="startHuntContainer" style="display: none; margin-top: 20px;">
        <button class="main-button" onclick="startHunt()">Start Hunt</button>
        <button class="main-button logout-button" onclick="teamLogout()">Logout</button>
    </div>

    <!-- Coordinate Finder Container -->
    <div class="container" id="coordinateFinder">
        <h2>Enter Your 6-Digit Code</h2>
        <div id="coordinateDisplay"></div>
        <input type="text" id="codeInput" placeholder="Enter your code here..." maxlength="6">
        <button onclick="getNextCoordinates()">Submit</button>
        <div class="output" id="output"></div>
        <div class="output" id="scoreDisplay"></div>
        <button class="main-button logout-button" onclick="teamLogout()">Logout</button>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('adminLoginModal')">&times;</span>
            <h2>Admin Login</h2>
            <input type="password" id="adminPassword" placeholder="Enter Admin Password" required>
            <button type="button" onclick="adminLogin()">Login</button>
            <div class="output" id="adminLoginOutput"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="adminDashboard">
        <h2>Admin Dashboard</h2>
        <button onclick="openAdminOptionModal('leaderboard')">Leaderboard</button>
        <button onclick="openAdminOptionModal('teamSequences')">Team Question Sequences</button>
        <button onclick="openAdminOptionModal('submissionTimes')">Submission Times</button>
        <button onclick="openRegistrationRequestsModal()">Registration Requests</button>
        <button onclick="openSetTimeModal()">Set Event Time</button>
        <button class="reset-button" onclick="resetEvent()">Reset Event</button>
        <button class="main-button logout-button" onclick="adminLogout()">Logout</button>
    </div>

    <!-- Admin Option Modal -->
    <div id="adminOptionModal" class="admin-option-modal">
        <span class="close" onclick="closeAdminOptionModal()">&times;</span>
        <h3 id="adminOptionTitle">Option Title</h3>
        <pre id="adminOptionContent">Option Content</pre>
    </div>

    <!-- Registration Request Modal -->
    <div id="registrationRequestModal" class="admin-option-modal">
        <span class="close" onclick="closeModal('registrationRequestModal')">&times;</span>
        <h3>Registration Requests</h3>
        <div id="registrationRequestsContent">
            <!-- Registration requests will be displayed here -->
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="resetModal" class="reset-modal">
        <span class="close" onclick="closeModal('resetModal')">&times;</span>
        <h3>Confirm Reset</h3>
        <p>Are you sure you want to reset the event? This will remove all data.</p>
        <div>
            <button onclick="confirmResetEvent()">Yes, Reset</button>
            <button onclick="closeModal('resetModal')">Cancel</button>
        </div>
    </div>

    <!-- Set Time Modal -->
    <div id="setTimeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('setTimeModal')">&times;</span>
            <h2>Set Event Time</h2>
            <label for="eventStartInput">Event Start Time:</label>
            <input type="datetime-local" id="eventStartInput">
            <label for="eventEndInput">Event End Time:</label>
            <input type="datetime-local" id="eventEndInput">
            <button type="button" onclick="setEventTime()">Set Time</button>
            <div class="output" id="setTimeOutput"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- JavaScript for Functionality -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCyVBia-bsTSwZSmGrztGGeyGvbk-3vGUM",
            authDomain: "night-sky-hunt-af24d.firebaseapp.com",
            databaseURL: "https://night-sky-hunt-af24d-default-rtdb.firebaseio.com",
            projectId: "night-sky-hunt-af24d",
            storageBucket: "night-sky-hunt-af24d.appspot.com",
            messagingSenderId: "649615581460",
            appId: "1:649615581460:web:13d2c0d15161e1ef43e201",
            measurementId: "G-YBD7B53TJJ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Starfield Generation
        const starfield = document.getElementById('starfield');
        const numStars = 200;

        for (let i = 0; i < numStars; i++) {
            const star = document.createElement('div');
            star.classList.add('star');
            const size = Math.random() * 2;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.top = `${Math.random() * 100}%`;
            star.style.left = `${Math.random() * 100}%`;
            star.style.animationDuration = `${1 + Math.random() * 3}s`;
            starfield.appendChild(star);
        }

        // Variables and Data
        let teams = {};
        let teamSequences = {};
        let teamScores = {};
        let submissionTimes = {};
        let registrationRequests = {};
        let eventStart = null;
        let eventEnd = null;
        let currentTeam = null;
        let adminLoggedIn = false;

        const coordinates = {
            1: [9.52, 12.81],
            2: [9.22, 11.43],
            3: [10.14, 10.75],
            4: [11.59, 10.80],
            5: [11.67, 9.59],
            6: [10.74, 6.86],
            7: [9.44, 5.75],
            8: [9.00, 6.86],
            9: [8.59, 7.86],
            10: [6.52, 6.64],
            11: [5.85, 5.80],
            12: [4.07, 5.86],
            13: [3.44, 8.00],
            14: [5.07, 9.53],
            15: [7.00, 8.70],
            16: [7.00, 9.64],
            17: [8.00, 11.00],
            18: [6.07, 4.14],
            19: [10.44, 12.00],
            20: [11.52, 8.44]
        };

        const questionCodes = {
            1: 3742,
            2: 8169,
            3: 2905,
            4: 6471,
            5: 5038,
            6: 7294,
            7: 1806,
            8: 9532,
            9: 4087,
            10: 6129,
            11: 3748,
            12: 5902,
            13: 8251,
            14: 4937,
            15: 1065,
            16: 7489,
            17: 2541,
            18: 6390,
            19: 4718,
            20: 8023
        };

        // Fetch Initial Data from Firebase
        function fetchInitialData() {
            firebase.database().ref('/').on('value', (snapshot) => {
                const data = snapshot.val();
                teams = data?.teams || {};
                teamSequences = data?.teamSequences || {};
                teamScores = data?.teamScores || {};
                submissionTimes = data?.submissionTimes || {};
                registrationRequests = data?.registrationRequests || {};
                eventStart = data?.eventStart ? parseInt(data.eventStart, 10) : null;
                eventEnd = data?.eventEnd ? parseInt(data.eventEnd, 10) : null;

                // If a team is currently logged in, update their score and question index
                if (currentTeam && teams[currentTeam]) {
                    document.getElementById('scoreDisplay').textContent = `Your current score: ${teamScores[currentTeam] || 0} points`;
                    const currentIndex = teams[currentTeam].currentQuestionIndex || 0;
                    const sequence = teamSequences[currentTeam];
                    if (currentIndex < sequence.length) {
                        const currentQuestionNumber = sequence[currentIndex];
                        const [x, y] = coordinates[currentQuestionNumber];
                        document.getElementById('coordinateDisplay').textContent = `Your coordinates are: (${x}, ${y})`;
                    } else {
                        document.getElementById('coordinateDisplay').textContent = '';
                    }
                }

                // Update Leaderboard if Admin is viewing
                if (adminLoggedIn) {
                    // You can trigger leaderboard refresh here if needed
                }
            });
        }

        fetchInitialData();

        // Function Definitions

        // Initialize member inputs with minimum 2 members
        function initializeMemberInputs() {
            const memberInputs = document.getElementById('memberInputs');
            memberInputs.innerHTML = '';
            for (let i = 1; i <= 2; i++) {
                addMemberInput(i);
            }
            memberCount = 2;
        }

        let memberCount = 2;

        function addMemberInput(i) {
            const memberInputs = document.getElementById('memberInputs');

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = `Member ${i} Name`;
            nameInput.required = true;
            nameInput.className = 'member-name';

            const idInput = document.createElement('input');
            idInput.type = 'text';
            idInput.placeholder = `Member ${i} ID`;
            idInput.required = true;
            idInput.className = 'member-id';

            memberInputs.appendChild(nameInput);
            memberInputs.appendChild(idInput);
        }

        function addMember() {
            if (memberCount >= 4) {
                alert('Maximum 4 members allowed.');
                return;
            }
            memberCount++;
            addMemberInput(memberCount);
        }

        function removeMember() {
            if (memberCount <= 2) {
                alert('Minimum 2 members required.');
                return;
            }
            const memberInputs = document.getElementById('memberInputs');
            memberInputs.removeChild(memberInputs.lastChild);
            memberInputs.removeChild(memberInputs.lastChild);
            memberCount--;
        }

        // Register Team
        function registerTeam() {
            const names = Array.from(document.getElementsByClassName('member-name')).map(input => input.value.trim());
            const ids = Array.from(document.getElementsByClassName('member-id')).map(input => input.value.trim());
            const teamName = document.getElementById('teamName').value.trim();
            const teamLeaderEmail = document.getElementById('teamLeaderEmail').value.trim();
            const password = document.getElementById('teamPassword').value.trim();
            const acceptanceCodeInput = document.getElementById('acceptanceCodeInput');
            const outputDiv = document.getElementById('addTeamOutput');

            if (names.includes('') || ids.includes('') || teamName === '' || password === '' || teamLeaderEmail === '') {
                outputDiv.textContent = 'Please fill all fields.';
                return;
            }

            firebase.database().ref('/').once('value').then((snapshot) => {
                const data = snapshot.val();
                teams = data?.teams || {};
                registrationRequests = data?.registrationRequests || {};

                for (let existingTeam in teams) {
                    if (teams[existingTeam].teamName.toLowerCase() === teamName.toLowerCase()) {
                        outputDiv.textContent = `Team name "${teamName}" is already registered.`;
                        return;
                    }
                }

                if (registrationRequests[teamName]) {
                    const request = registrationRequests[teamName];
                    if (request.status === 'pending') {
                        outputDiv.textContent = 'Not approved by the admin.';
                    } else if (request.status === 'approved') {
                        document.getElementById('acceptanceCodeSection').style.display = 'block';
                        if (acceptanceCodeInput.value.trim() === '') {
                            outputDiv.textContent = 'Please enter the acceptance code provided by the admin.';
                            return;
                        }
                        if (acceptanceCodeInput.value.trim() === request.acceptanceCode) {
                            const teamId = 'T' + new Date().getTime();

                            teams[teamId] = {
                                teamName,
                                names,
                                ids,
                                teamLeaderEmail,
                                password,
                                currentQuestionIndex: 0
                            };

                            teamSequences[teamId] = generateRandomSequence(20);

                            teamScores[teamId] = 0;
                            submissionTimes[teamId] = null;

                            firebase.database().ref('/teams/' + teamId).set(teams[teamId]);
                            firebase.database().ref('/teamSequences/' + teamId).set(teamSequences[teamId]);
                            firebase.database().ref('/teamScores/' + teamId).set(teamScores[teamId]);
                            firebase.database().ref('/submissionTimes/' + teamId).set(submissionTimes[teamId]);

                            delete registrationRequests[teamName];
                            firebase.database().ref('/registrationRequests/' + teamName).remove();

                            outputDiv.textContent = 'Team registered successfully!';
                            document.getElementById('teamForm').reset();
                            initializeMemberInputs();
                            document.getElementById('acceptanceCodeSection').style.display = 'none';
                        } else {
                            outputDiv.textContent = 'Invalid acceptance code.';
                        }
                    }
                } else {
                    registrationRequests[teamName] = {
                        teamName,
                        names,
                        ids,
                        teamLeaderEmail,
                        password,
                        status: 'pending'
                    };
                    firebase.database().ref('/registrationRequests/' + teamName).set(registrationRequests[teamName]);
                    outputDiv.textContent = 'Registration request submitted. Please wait for admin approval.';
                    document.getElementById('teamForm').reset();
                    initializeMemberInputs();
                }
            });
        }

        // Generate random sequence
        function generateRandomSequence(n) {
            const array = Array.from({length: n}, (_, index) => index + 1);
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Team Login
        function teamLogin() {
            const teamName = document.getElementById('teamNameLogin').value.trim();
            const password = document.getElementById('teamPasswordLogin').value.trim();
            const outputDiv = document.getElementById('startHuntOutput');

            firebase.database().ref('/teams').once('value').then((snapshot) => {
                teams = snapshot.val() || {};
                let found = false;
                let teamIdFound = null;
                for (let teamId in teams) {
                    if (teams[teamId].teamName.toLowerCase() === teamName.toLowerCase() && teams[teamId].password === password) {
                        found = true;
                        teamIdFound = teamId;
                        break;
                    }
                }

                if (found) {
                    currentTeam = teamIdFound;
                    outputDiv.textContent = 'Login successful!';
                    document.getElementById('startHuntModal').style.display = 'none';
                    document.getElementById('startHuntContainer').style.display = 'block';
                    document.getElementById('buttonContainer').style.display = 'none';
                } else {
                    outputDiv.textContent = 'Invalid team name or password.';
                }
            });
        }

        // Start Hunt
        function startHunt() {
            checkEventStatus().then((status) => {
                if (status === 'notSet') {
                    alert('Event time not set by admin.');
                    return;
                }
                if (status === 'notStarted') {
                    alert('Event not started yet.');
                    return;
                } else if (status === 'ended') {
                    alert('Event has ended.');
                    return;
                }

                document.getElementById('startHuntContainer').style.display = 'none';
                document.getElementById('coordinateFinder').style.display = 'block';

                const sequence = teamSequences[currentTeam];
                let currentIndex = teams[currentTeam].currentQuestionIndex;

                if (currentIndex === undefined || currentIndex === null) {
                    currentIndex = 0;
                    firebase.database().ref('/teams/' + currentTeam + '/currentQuestionIndex').set(currentIndex);
                }

                if (currentIndex < sequence.length) {
                    const currentQuestionNumber = sequence[currentIndex];
                    const [x, y] = coordinates[currentQuestionNumber];
                    document.getElementById('coordinateDisplay').textContent = `Your coordinates are: (${x}, ${y})`;
                } else {
                    document.getElementById('coordinateDisplay').textContent = '';
                    alert("Congratulations! You have completed all questions!");
                }

                // Display current score
                firebase.database().ref('/teamScores/' + currentTeam).once('value').then((scoreSnapshot) => {
                    teamScores = scoreSnapshot.val() || 0;
                    document.getElementById('scoreDisplay').textContent = `Your current score: ${teamScores} points`;
                });
            });
        }

        // Team Logout
        function teamLogout() {
            currentTeam = null;
            document.getElementById('coordinateFinder').style.display = 'none';
            document.getElementById('buttonContainer').style.display = 'flex';
            document.getElementById('codeInput').value = '';
            document.getElementById('output').textContent = '';
            document.getElementById('coordinateDisplay').textContent = '';
            document.getElementById('scoreDisplay').textContent = '';
            document.getElementById('startHuntContainer').style.display = 'none';
        }

        // Get Next Coordinates
        function getNextCoordinates() {
            if (!currentTeam) {
                alert('Please login first.');
                return;
            }

            checkEventStatus().then((status) => {
                if (status === 'notSet') {
                    alert('Event time not set by admin.');
                    return;
                }
                if (status === 'notStarted') {
                    alert("Event not started yet.");
                    return;
                } else if (status === 'ended') {
                    alert("Sorry, the event has ended.");
                    document.getElementById('coordinateFinder').style.display = 'none';
                    alert("Event has ended.");
                    return;
                }

                const input = document.getElementById('codeInput').value.trim();
                const outputDiv = document.getElementById('output');

                if (!/^\d{6}$/.test(input)) {
                    outputDiv.textContent = "Please enter a valid 6-digit code.";
                    return;
                }

                const currentQuestionCode = parseInt(input.slice(2), 10);

                let currentQuestionNumber = null;
                for (const [qNum, qCode] of Object.entries(questionCodes)) {
                    if (qCode === currentQuestionCode) {
                        currentQuestionNumber = parseInt(qNum, 10);
                        break;
                    }
                }

                if (!currentQuestionNumber) {
                    outputDiv.textContent = "Invalid question code.";
                    return;
                }

                const sequence = teamSequences[currentTeam];
                let currentIndex = teams[currentTeam].currentQuestionIndex;

                if (currentIndex === undefined || currentIndex === null) {
                    currentIndex = 0;
                }

                if (sequence[currentIndex] !== currentQuestionNumber) {
                    outputDiv.textContent = "Incorrect code. Please try again.";
                    return;
                }

                // Update team's progress
                currentIndex++;
                firebase.database().ref('/teams/' + currentTeam + '/currentQuestionIndex').set(currentIndex);

                // Update team score
                firebase.database().ref('/teamScores/' + currentTeam).once('value').then((scoreSnapshot) => {
                    teamScores = scoreSnapshot.val() || 0;
                    teamScores += 5;
                    firebase.database().ref('/teamScores/' + currentTeam).set(teamScores);
                    document.getElementById('scoreDisplay').textContent = `Your current score: ${teamScores} points`;
                });

                // Update submission time
                const currentTime = new Date().toLocaleString();
                submissionTimes[currentTeam] = currentTime;
                firebase.database().ref('/submissionTimes/' + currentTeam).set(currentTime);

                // Provide next coordinate or completion message
                if (currentIndex < sequence.length) {
                    const nextQuestionNumber = sequence[currentIndex];
                    const [x, y] = coordinates[nextQuestionNumber];
                    outputDiv.textContent = `Correct! The coordinates of your next question are: (${x}, ${y})`;
                    document.getElementById('coordinateDisplay').textContent = '';
                } else {
                    outputDiv.textContent = "Congratulations! You have completed all questions!";
                    document.getElementById('coordinateDisplay').textContent = '';
                }

                // Clear input
                document.getElementById('codeInput').value = '';
            });
        }

        // Admin Login
        function adminLogin() {
            const password = document.getElementById('adminPassword').value.trim();
            const outputDiv = document.getElementById('adminLoginOutput');

            const adminPassword = 'admin123'; // Change this to your desired admin password

            if (password === adminPassword) {
                adminLoggedIn = true;
                outputDiv.textContent = 'Login successful!';
                document.getElementById('adminLoginModal').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                document.getElementById('buttonContainer').style.display = 'none';
            } else {
                outputDiv.textContent = 'Incorrect password.';
            }
        }

        // Admin Logout
        function adminLogout() {
            adminLoggedIn = false;
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('buttonContainer').style.display = 'flex';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginOutput').textContent = '';
        }

        // Show Leaderboard
        function showLeaderboard() {
            if (!adminLoggedIn) return;
            const adminOptionTitle = document.getElementById('adminOptionTitle');
            const adminOptionContent = document.getElementById('adminOptionContent');
            const adminOptionModal = document.getElementById('adminOptionModal');

            firebase.database().ref('/').once('value').then((snapshot) => {
                const data = snapshot.val();
                teams = data?.teams || {};
                teamScores = data?.teamScores || {};

                let leaderboard = [];

                for (let teamId in teamScores) {
                    leaderboard.push({
                        teamId,
                        score: teamScores[teamId]
                    });
                }

                leaderboard.sort((a, b) => b.score - a.score);

                let output = 'Leaderboard:\n\n';
                leaderboard.forEach((entry, index) => {
                    output += `${index + 1}. ${teams[entry.teamId]?.teamName || 'Unknown Team'} (${entry.teamId}) - ${entry.score} points\n`;
                });

                adminOptionTitle.textContent = 'Leaderboard';
                adminOptionContent.textContent = output;
                adminOptionModal.style.display = 'block';
            });
        }

        // Show Team Sequences
        function showTeamSequences() {
            if (!adminLoggedIn) return;
            const adminOptionTitle = document.getElementById('adminOptionTitle');
            const adminOptionContent = document.getElementById('adminOptionContent');
            const adminOptionModal = document.getElementById('adminOptionModal');

            firebase.database().ref('/').once('value').then((snapshot) => {
                const data = snapshot.val();
                teams = data?.teams || {};
                teamSequences = data?.teamSequences || {};

                let output = 'Team Question Sequences:\n\n';

                for (let teamId in teamSequences) {
                    output += `${teams[teamId]?.teamName || 'Unknown Team'} (${teamId}): ${teamSequences[teamId].join(', ')}\n`;
                }

                adminOptionTitle.textContent = 'Team Question Sequences';
                adminOptionContent.textContent = output;
                adminOptionModal.style.display = 'block';
            });
        }

        // Show Submission Times
        function showSubmissionTimes() {
            if (!adminLoggedIn) return;
            const adminOptionTitle = document.getElementById('adminOptionTitle');
            const adminOptionContent = document.getElementById('adminOptionContent');
            const adminOptionModal = document.getElementById('adminOptionModal');

            firebase.database().ref('/').once('value').then((snapshot) => {
                const data = snapshot.val();
                teams = data?.teams || {};
                submissionTimes = data?.submissionTimes || {};

                let output = 'Latest Submission Times:\n\n';

                for (let teamId in submissionTimes) {
                    output += `${teams[teamId]?.teamName || 'Unknown Team'} (${teamId}): ${submissionTimes[teamId] || 'No submissions yet'}\n`;
                }

                adminOptionTitle.textContent = 'Submission Times';
                adminOptionContent.textContent = output;
                adminOptionModal.style.display = 'block';
            });
        }

        // Reset Event
        function resetEvent() {
            openResetModal();
        }

        // Open Reset Confirmation Modal
        function openResetModal() {
            if (!adminLoggedIn) return;
            document.getElementById('resetModal').style.display = 'block';
        }

        // Confirm Reset Event
        function confirmResetEvent() {
            firebase.database().ref('/').set(null).then(() => {
                teams = {};
                teamSequences = {};
                teamScores = {};
                submissionTimes = {};
                registrationRequests = {};
                eventStart = null;
                eventEnd = null;
                closeModal('resetModal');
                alert('Event has been reset.');
                adminLogout();
            });
        }

        // Open Set Time Modal
        function openSetTimeModal() {
            if (!adminLoggedIn) return;
            document.getElementById('setTimeModal').style.display = 'block';
        }

        // Set Event Time
        function setEventTime() {
            const eventStartInput = document.getElementById('eventStartInput').value;
            const eventEndInput = document.getElementById('eventEndInput').value;
            const outputDiv = document.getElementById('setTimeOutput');

            if (!eventStartInput || !eventEndInput) {
                outputDiv.textContent = 'Please select both start and end times.';
                return;
            }

            const startTime = new Date(eventStartInput).getTime();
            const endTime = new Date(eventEndInput).getTime();

            if (endTime <= startTime) {
                outputDiv.textContent = 'End time must be after start time.';
                return;
            }

            firebase.database().ref('/eventStart').set(startTime.toString());
            firebase.database().ref('/eventEnd').set(endTime.toString());

            outputDiv.textContent = 'Event time has been set successfully!';
        }

        // Handle clicks outside modals to close them
        window.onclick = function(event) {
            const modals = ['addTeamModal', 'startHuntModal', 'adminLoginModal', 'adminOptionModal', 'setTimeModal', 'resetModal', 'registrationRequestModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    closeModal(modalId);
                }
            });
        }

        // Admin Option Modal Functions
        function openAdminOptionModal(option) {
            if (!adminLoggedIn) return;
            switch(option) {
                case 'leaderboard':
                    showLeaderboard();
                    break;
                case 'teamSequences':
                    showTeamSequences();
                    break;
                case 'submissionTimes':
                    showSubmissionTimes();
                    break;
                default:
                    break;
            }
        }

        function closeAdminOptionModal() {
            document.getElementById('adminOptionModal').style.display = 'none';
            document.getElementById('adminOptionContent').textContent = '';
            document.getElementById('adminOptionTitle').textContent = 'Option Title';
        }

        // Event Timing Control
        function checkEventStatus() {
            return firebase.database().ref('/').once('value').then((snapshot) => {
                const data = snapshot.val();
                eventStart = data?.eventStart ? parseInt(data.eventStart, 10) : null;
                eventEnd = data?.eventEnd ? parseInt(data.eventEnd, 10) : null;
                const now = new Date().getTime();
                if (!eventStart || !eventEnd) {
                    return 'notSet';
                }
                if (now < eventStart) {
                    return 'notStarted';
                } else if (now > eventEnd) {
                    return 'ended';
                } else {
                    return 'ongoing';
                }
            });
        }

        // Open Registration Requests Modal
        function openRegistrationRequestsModal() {
            if (!adminLoggedIn) return;
            document.getElementById('registrationRequestModal').style.display = 'block';
            displayRegistrationRequests();
        }

        // Display Registration Requests
        function displayRegistrationRequests() {
            const requestsDiv = document.getElementById('registrationRequestsContent');
            requestsDiv.innerHTML = '';

            firebase.database().ref('/registrationRequests').once('value').then((snapshot) => {
                registrationRequests = snapshot.val() || {};

                for (let teamName in registrationRequests) {
                    const request = registrationRequests[teamName];
                    const requestDiv = document.createElement('div');
                    requestDiv.className = 'registration-request';

                    const teamInfo = document.createElement('span');
                    teamInfo.textContent = `Team: ${teamName}, Members: ${request.names.join(', ')}`;

                    if (request.status === 'pending') {
                        const acceptButton = document.createElement('button');
                        acceptButton.textContent = 'Approve';
                        acceptButton.onclick = () => acceptRegistrationRequest(teamName, acceptButton);
                        requestDiv.appendChild(teamInfo);
                        requestDiv.appendChild(acceptButton);
                    } else if (request.status === 'approved') {
                        const codeSpan = document.createElement('span');
                        codeSpan.innerHTML = `Acceptance Code: <span class="acceptance-code">${request.acceptanceCode}</span>`;
                        requestDiv.appendChild(teamInfo);
                        requestDiv.appendChild(codeSpan);
                    }

                    requestsDiv.appendChild(requestDiv);
                }

                if (Object.keys(registrationRequests).length === 0) {
                    requestsDiv.textContent = 'No registration requests.';
                }
            });
        }

        // Accept Registration Request
        function acceptRegistrationRequest(teamName, buttonElement) {
            const code = generateAcceptanceCode();
            registrationRequests[teamName].status = 'approved';
            registrationRequests[teamName].acceptanceCode = code;
            firebase.database().ref('/registrationRequests/' + teamName).update({
                status: 'approved',
                acceptanceCode: code
            }).then(() => {
                // Update the UI
                const codeSpan = document.createElement('span');
                codeSpan.innerHTML = `Acceptance Code: <span class="acceptance-code">${code}</span>`;
                const parentDiv = buttonElement.parentElement;
                parentDiv.removeChild(buttonElement);
                parentDiv.appendChild(codeSpan);
            });
        }

        // Generate Acceptance Code
        function generateAcceptanceCode() {
            let code = '';
            for (let i = 0; i < 3; i++) {
                code += Math.floor(Math.random() * 10);
            }
            return code;
        }

        // Handle event end
        function handleEventEnd() {
            checkEventStatus().then((status) => {
                if (status === 'ended') {
                    if (currentTeam) {
                        alert("Event has ended.");
                        teamLogout();
                    }
                }
            });
        }

        // Set interval to check event status every minute
        setInterval(handleEventEnd, 60000);

        // Function to open modals
        function openAddTeamModal() {
            document.getElementById('addTeamModal').style.display = 'block';
            initializeMemberInputs();
        }

        function openStartHuntModal() {
            document.getElementById('startHuntModal').style.display = 'block';
        }

        function openAdminLoginModal() {
            document.getElementById('adminLoginModal').style.display = 'block';
        }

        // Function to close modals
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Clear output messages
            if (modalId === 'addTeamModal') {
                document.getElementById('addTeamOutput').textContent = '';
                document.getElementById('acceptanceCodeInput').value = '';
                document.getElementById('acceptanceCodeSection').style.display = 'none';
            } else if (modalId === 'startHuntModal') {
                document.getElementById('startHuntOutput').textContent = '';
            } else if (modalId === 'adminLoginModal') {
                document.getElementById('adminLoginOutput').textContent = '';
            } else if (modalId === 'adminOptionModal') {
                document.getElementById('adminOptionContent').textContent = '';
                document.getElementById('adminOptionTitle').textContent = 'Option Title';
            } else if (modalId === 'setTimeModal') {
                document.getElementById('setTimeOutput').textContent = '';
            } else if (modalId === 'resetModal') {
                // No additional action needed
            } else if (modalId === 'registrationRequestModal') {
                // No additional action needed
            }
        }

    </script>

</body>
</html>
